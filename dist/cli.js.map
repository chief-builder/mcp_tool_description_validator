{"version":3,"sources":["../src/cli.ts"],"sourcesContent":["#!/usr/bin/env node\n/**\n * MCP Tool Validator - CLI Entry Point\n *\n * Command-line interface for validating MCP tool definitions.\n */\n\nimport { Command } from 'commander';\nimport chalk from 'chalk';\nimport { validateFile, validateServer } from './core/validator.js';\nimport {\n  formatHumanOutput,\n  formatJsonOutput,\n  formatSarifOutput,\n} from './reporters/index.js';\nimport type { ValidatorConfig, IssueSeverity } from './types/index.js';\n\nconst program = new Command();\n\n/**\n * Collect multiple --rule options into a record.\n */\nexport function collectRules(\n  value: string,\n  previous: Record<string, string>\n): Record<string, string> {\n  const eqIndex = value.indexOf('=');\n  if (eqIndex === -1) {\n    // Invalid format, just store as-is with empty value\n    previous[value] = '';\n    return previous;\n  }\n  const id = value.slice(0, eqIndex);\n  const setting = value.slice(eqIndex + 1);\n  if (id && setting) {\n    previous[id] = setting;\n  }\n  return previous;\n}\n\n/**\n * Parse rule settings from CLI into config format.\n */\nexport function parseRuleOverrides(\n  ruleOverrides: Record<string, string>\n): Record<string, boolean | IssueSeverity> {\n  const rules: Record<string, boolean | IssueSeverity> = {};\n\n  for (const [id, setting] of Object.entries(ruleOverrides)) {\n    const normalizedSetting = setting.toLowerCase();\n    if (normalizedSetting === 'off' || normalizedSetting === 'false') {\n      rules[id] = false;\n    } else if (normalizedSetting === 'on' || normalizedSetting === 'true') {\n      rules[id] = true;\n    } else if (\n      normalizedSetting === 'error' ||\n      normalizedSetting === 'warning' ||\n      normalizedSetting === 'suggestion'\n    ) {\n      rules[id] = normalizedSetting as IssueSeverity;\n    }\n  }\n\n  return rules;\n}\n\n/**\n * CLI options interface.\n */\nexport interface CLIOptions {\n  server?: string;\n  format: 'human' | 'json' | 'sarif';\n  config?: string;\n  rule: Record<string, string>;\n  llm?: boolean;\n  llmProvider?: string;\n  verbose?: boolean;\n  quiet?: boolean;\n  ci?: boolean;\n  color: boolean;\n}\n\n/**\n * Run the validation based on CLI arguments.\n */\nasync function runValidation(\n  file: string | undefined,\n  options: CLIOptions\n): Promise<void> {\n  // Must have either file or --server\n  if (!file && !options.server) {\n    console.error(\n      chalk.red('Error:'),\n      'Must provide a file path or --server option'\n    );\n    process.exit(2);\n  }\n\n  // Build config from options\n  const config: Partial<ValidatorConfig> = {\n    output: {\n      format: options.format,\n      verbose: options.verbose ?? false,\n      color: options.color !== false,\n    },\n    rules: parseRuleOverrides(options.rule || {}),\n  };\n\n  // Handle LLM options\n  if (options.llm) {\n    config.llm = {\n      enabled: true,\n      provider: options.llmProvider || 'anthropic',\n      model: '',\n      timeout: 30000,\n    };\n  }\n\n  // Run validation\n  const result = file\n    ? await validateFile(file, { config, configPath: options.config })\n    : await validateServer(options.server!, { config, configPath: options.config });\n\n  // Format output\n  let output: string;\n  switch (options.format) {\n    case 'json':\n      output = formatJsonOutput(result);\n      break;\n    case 'sarif':\n      output = formatSarifOutput(result);\n      break;\n    default:\n      output = formatHumanOutput(result, {\n        color: options.color !== false,\n        verbose: options.verbose,\n      });\n  }\n\n  // In quiet mode with human format, filter to only errors\n  if (options.quiet && options.format === 'human') {\n    const lines = output.split('\\n');\n    const filteredLines = lines.filter((line) => {\n      // Keep header lines, error lines, and summary\n      return (\n        line.includes('MCP Tool Validator') ||\n        line.includes('Validating:') ||\n        line.includes('ERROR') ||\n        line.includes('Summary:') ||\n        line.includes('Errors:') ||\n        line.includes('Validation failed') ||\n        line.includes('Validation passed') ||\n        line.match(/^[^\\s]/) || // Tool names (start of line)\n        line.trim() === '' ||\n        line.includes('â”€')\n      );\n    });\n    output = filteredLines.join('\\n');\n  }\n\n  console.log(output);\n\n  // Exit code\n  if (options.ci && !result.valid) {\n    process.exit(1);\n  }\n}\n\n// Configure the main program\nprogram\n  .name('mcp-validate')\n  .description(\n    'Validate MCP tool definitions for quality, security, and LLM compatibility'\n  )\n  .version('0.1.0')\n  .argument('[file]', 'Tool definition file to validate (JSON or YAML)')\n  .option('-s, --server <url>', 'Validate tools from a live MCP server')\n  .option(\n    '-f, --format <format>',\n    'Output format: human, json, sarif',\n    'human'\n  )\n  .option('-c, --config <path>', 'Path to config file')\n  .option(\n    '-r, --rule <rule>',\n    'Override rule: RULE-ID=on|off|error|warning|suggestion',\n    collectRules,\n    {}\n  )\n  .option('--llm', 'Enable LLM-assisted analysis')\n  .option(\n    '--llm-provider <provider>',\n    'LLM provider: openai, anthropic, ollama'\n  )\n  .option('-v, --verbose', 'Verbose output')\n  .option('-q, --quiet', 'Only show errors')\n  .option('--ci', 'CI mode: exit 1 on any error')\n  .option('--no-color', 'Disable colored output')\n  .action(async (file: string | undefined, options: CLIOptions) => {\n    try {\n      await runValidation(file, options);\n    } catch (error) {\n      console.error(\n        chalk.red('Error:'),\n        error instanceof Error ? error.message : error\n      );\n      process.exit(2);\n    }\n  });\n\n// Add serve subcommand for HTTP service\nprogram\n  .command('serve')\n  .description('Start HTTP validation service')\n  .option('-p, --port <port>', 'Port to listen on', '8080')\n  .option('-h, --host <host>', 'Host to bind to', 'localhost')\n  .action(async (options: { port: string; host: string }) => {\n    // Placeholder - actual server implementation in CHUNK-14\n    console.log(`Starting validation server on ${options.host}:${options.port}...`);\n    console.log(chalk.yellow('HTTP service not yet implemented'));\n    console.log('This will be available in a future release.');\n  });\n\n// Export the program for testing\nexport { program };\n\n// Only parse if this is the main module (not imported for testing)\n// Check if we're being run directly vs imported\nconst isMainModule =\n  typeof process !== 'undefined' &&\n  process.argv[1] &&\n  (process.argv[1].endsWith('cli.js') ||\n    process.argv[1].endsWith('cli.ts') ||\n    process.argv[1].endsWith('mcp-validate.js') ||\n    process.argv[1].includes('/bin/mcp-validate'));\n\nif (isMainModule) {\n  program.parse();\n}\n"],"mappings":"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","names":[]}